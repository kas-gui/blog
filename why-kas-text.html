<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Why KAS-text - KAS blog</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Index</a></li><li class="chapter-item expanded "><a href="why-kas-text.html" class="active"><strong aria-hidden="true">2.</strong> Why KAS-text</a></li><li class="chapter-item expanded "><a href="line-wrapping.html"><strong aria-hidden="true">3.</strong> Line wrapping</a></li><li class="chapter-item expanded "><a href="easy-cast.html"><strong aria-hidden="true">4.</strong> Easy Cast</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">KAS blog</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="why-i-created-kas-text"><a class="header" href="#why-i-created-kas-text">Why I created kas-text</a></h1>
<p>September 2020</p>
<h2 id="existing-libraries"><a class="header" href="#existing-libraries">Existing libraries</a></h2>
<p>This is going to be a very brief (and fairly naive) dive into text rendering and
the state of available Rust libraries, written in easy English with minimal
jargon.</p>
<h3 id="the-basics"><a class="header" href="#the-basics">The basics</a></h3>
<p>Lets see. You're writing a small graphical game/tool/general UI and wish to
print a simple string of text, say, &quot;Hello World!&quot; There are many APIs that can
do this, but still several steps involved:</p>
<ol>
<li>Selecting a font: this might be embedded or the app may try to discover a
&quot;standard&quot; system font. The <code>font-kit</code> crate can discover system fonts.</li>
<li>Reading the font: there are a selection of libraries available, from the
low level <code>ttf-parser</code> to the mid-level <code>ab_glyph</code> to more complex toolsets
including <code>font-kit</code>, <code>rusttype</code> and <code>fontdue</code>.</li>
<li>Translating the input string to a sequence of positioned and scaled glyphs
(<em>layout</em>): the above-mentioned <code>font-kit</code>, <code>rusttype</code> and <code>fontdue</code> can
all accomplish this, along with the more specialised <code>glyph_brush_layout</code>.</li>
<li>Rasterising glyphs: this is the job of <code>glyph_brush</code> and, again, <code>font-kit</code>,
<code>rusttype</code> and <code>fontdue</code>.</li>
<li>Integrating rasterisation with the graphics pipeline: e.g. <code>gfx_glyph</code> and
<code>wgpu_glyph</code> do this job. Several high-level libraries (e.g. <code>ggez</code> and
<code>amethyst_ui</code>) provide direct text support.</li>
</ol>
<p>Of course, mostly you only need consider steps 1 and 5 and you're done.</p>
<h3 id="wrapping-and-alignment"><a class="header" href="#wrapping-and-alignment">Wrapping and alignment</a></h3>
<p>Above, we considered only a short line of text: &quot;Hello World!&quot; Frequently you
will have longer pieces of text that require <em>wrapping</em> (usually on word
boundaries), and you may wish the result to be <em>aligned</em> to the left, centre or
right, or even <em>justified</em>. Fortunately the above libraries already have you
covered (aside from justified text, which is less often supported).</p>
<p>Text wrapping is a deceptively simple problem, but more on that in my
<a href="line-wrapping.html">next post</a>.</p>
<h3 id="shaping"><a class="header" href="#shaping">Shaping</a></h3>
<p>The above libraries all use a fairly simple layout system: match each <code>char</code> to
a font glyph, place this at the previous glyph's &quot;advance position&quot;, then if the
font provides kerning data for this pair of glyphs use it to adjust the gap
between the two. For English (and probably most languages) this is sufficient,
at least most of the time.</p>
<p><em>Shaping</em> allows more complex glyph selection and positioning, and is an
important part of <em>real</em> text libraries. See e.g.
<a href="https://harfbuzz.github.io/what-is-harfbuzz.html#what-is-text-shaping">HarfBuzz on shaping</a>
and
<a href="https://en.wikipedia.org/wiki/Complex_text_layout">Wikipedia on Complex Text Layout</a>
(although the latter also concerns bidirectional text; more on that later).</p>
<p>Essentially, shaping takes a text string along with a font and spits out a
sequence of positioned glyphs. This means that replacing the basic layout system
used above with a <em>text shaper</em> should, in theory, be straightforward.</p>
<p>For Rust, we have the HarfBuzz binding <code>harfbuzz-rs</code>, as well as two immature
pure-Rust libraries, <code>rustybuzz</code> and <code>allsorts</code>. Of the general-purpose text
libraries, only <code>fontdue</code> includes shaping in its roadmap.</p>
<h3 id="right-to-left-and-bidirectional-text"><a class="header" href="#right-to-left-and-bidirectional-text">Right-to-left and bidirectional text</a></h3>
<p>Several scripts, such as Hebrew and Arabic, are written right-to-left.
Supporting such scripts generally also requires supporting embedded left-to-right
fragments, and thus requires supporting <em>bidirectional</em> texts.</p>
<p>Unicode, as part of <a href="https://www.unicode.org/reports/tr9/">TR9</a>, specifies how
to determine the <em>bidi embedding level</em> and thus the text direction for each
character in the source text, as well as how to re-order the input from logical
order into display order. Unfortunately, integrating support for bidi
texts into layout is not so simple (this is most of the topic of the
<a href="line-wrapping.html">next post</a>).</p>
<p>The <code>unicode-bidi</code> crate implements much of Unicode TR9, but on its own this
is insufficient. <em>None</em> of the above libraries support bidirectional text.</p>
<h3 id="formatting"><a class="header" href="#formatting">Formatting</a></h3>
<p>Formatting may apply one of several effects to text. These include:</p>
<ul>
<li>adjusting the font size</li>
<li>changing the font's (foreground) colour</li>
<li>using a bold variant (or more generally, adjusting the weight)</li>
<li>using an italic variant (either via use of another font variant or via
slanting glyphs during rendering)</li>
<li>drawing underline or strikethrough</li>
</ul>
<p>Some of the above font libraries have limited support for formatting specified
via a list of text sections each with a font size and font identifier, and in
some cases also colour information. The user is expected to translate formatted
text from its source format as well as to select appropriate fonts.</p>
<h3 id="font-properties-and-variable-fonts"><a class="header" href="#font-properties-and-variable-fonts">Font properties and variable fonts</a></h3>
<p>When mentioning font selection above, we glossed over a couple of issues. How
does one select an appropriate italic or bold variant? Can these be synthesised
if not provided?</p>
<p>The <code>font-kit</code> crate can help with the above: it allows font selection by family,
weight and style. Some fonts are <em>variable</em>, meaning that glyphs can be
synthesised to the required weight (giving much more control than simply &quot;bold&quot;
or &quot;normal&quot;). The style allows selection of normal, <em>italic</em> (curved) or
<em>oblique</em> (slanted) variants.</p>
<p>I have not investigated this topic, but it appears that only <code>font-kit</code>'s
rasteriser API supports selection of weight or style; all other Rust libraries
select font only by path/bytes and variant index (for multiple fonts embedded
in a font pack).</p>
<h3 id="font-fallbacks"><a class="header" href="#font-fallbacks">Font fallbacks</a></h3>
<p>What if your chosen font doesn't include all required glyphs, e.g. if you choose
a font covering most European alphabets, but your user starts writing Korean?
I believe that no Rust libraries have even started trying to address this
problem.</p>
<p>The first sub-problem is an extension of font selection: choosing appropriate
fallback font(s). CSS allows the user direct control here: see
<a href="https://css-tricks.com/css-basics-fallback-font-stacks-robust-web-typography/">article</a>.
On Linux this is usually handled by Fontconfig.</p>
<p>The other sub-problem(s) concern integration: breaking text layout into multiple
runs should your shaper not support multiple fonts (as HarfBuzz doesn't), then
stitching the result back together.</p>
<h2 id="kas-text"><a class="header" href="#kas-text">KAS-text</a></h2>
<p>The above libraries cover simple layout and rasterisation fairly well, but
also leave a lot out, especially regarding complex layout and use of formatted
input texts.</p>
<p>KAS-text attempts to fill this gap: translate from a raw input text to a
sequence of positioned glyphs, which can be easily adapted for use by
renderers such as <code>wgpu_glyph</code>. Additionally, it exposes a stateful
<code>prepared::Text</code> object, allowing fast re-draws and re-wrapping of a given
input text (though this stateful API may not be appropriate for all users).</p>
<p>Since this article is written after-the-fact,
<a href="https://github.com/kas-gui/kas-text/"><code>kas-text</code></a> v0.1 already exists. You can
read its <a href="https://docs.rs/kas-text/">API docs here</a>. v0.1 already supports
shaping (via HarfBuzz) and bidirectional text, which, to my knowledge, makes it
the first Rust library to support these features (on the full layout cycle from
raw text input to positioned glyphs), admittedly with imperfections.</p>
<p>Near-future plans include support for formatted text, including translation from
Markdown or (simple) HTML input and mostly-automatic font selection.
Other topics, such as vertical text, font synthesis, font fallbacks and
emoticons, have not been planned but could eventually be added.</p>
<h3 id="kas-gui"><a class="header" href="#kas-gui">KAS GUI</a></h3>
<p>The v0.5 release of KAS has integration with KAS-text, including a reasonably
functional multi-line text-editor. <a href="https://github.com/kas-gui/kas/tree/master/kas-wgpu/examples#layout">Check it out</a> or run yourself:</p>
<pre><code class="language-sh">git clone https://github.com/kas-gui/kas.git
cd kas/kas-wgpu
cargo run --example layout --features shaping
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="line-wrapping.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="line-wrapping.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
